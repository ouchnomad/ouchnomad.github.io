<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–æ–ª–≥–æ–≤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Roboto Mono —Å Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700&display=swap" rel="stylesheet">
    <style>
      html, body {
        background: #18181b !important;
        font-family: 'Roboto Mono', monospace !important;
      }
      /* –°–∫—Ä—ã—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
      ::-webkit-scrollbar {
        width: 8px;
        background: #23232a;
      }
      ::-webkit-scrollbar-thumb {
        background: #33334a;
        border-radius: 4px;
      }
      /* –ü—Ä–∏–º–µ–Ω—è–µ–º Roboto Mono –∫–æ –≤—Å–µ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é */
      #app, #app * {
        font-family: 'Roboto Mono', monospace !important;
      }
      /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
      #app {
        max-width: 100vw;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }
      @media (min-width: 640px) {
        #app {
          max-width: 624px !important;
          padding-left: 0;
          padding-right: 0;
        }
      }
      @media (min-width: 768px) {
        #app {
          max-width: 624px !important;
        }
      }
      @media (min-width: 1024px) {
        #app {
          max-width: 624px !important;
        }
      }
      @media (min-width: 1280px) {
        #app {
          max-width: 624px !important;
        }
      }
      /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –∏ —Ä–∞–∑–º–µ—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      @media (max-width: 639px) {
        .p-6 { padding: 1rem !important; }
        .mb-6 { margin-bottom: 1rem !important; }
        .mt-8 { margin-top: 1rem !important; }
        .space-y-8 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem !important; }
        .rounded-lg { border-radius: 0.75rem !important; }
        .shadow-lg { box-shadow: 0 2px 8px 0 rgba(0,0,0,0.25) !important; }
        .w-80 { width: 100% !important; min-width: 0 !important; }
        .ml-2 { margin-left: 0.5rem !important; }
        .flex { flex-wrap: wrap; }
        .gap-2 { gap: 0.5rem !important; }
        .gap-4 { gap: 1rem !important; }
        .grid-cols-1 { grid-template-columns: 1fr !important; }
        .md\:grid-cols-2 { grid-template-columns: 1fr !important; }
        .md\:col-span-2 { grid-column: span 1 / span 1 !important; }
      }
      /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–æ–∫ –∏ –∏–Ω–ø—É—Ç–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      @media (max-width: 480px) {
        input, select, button {
          font-size: 0.95rem !important;
          padding: 0.5rem 0.75rem !important;
        }
        .px-3 { padding-left: 0.75rem !important; padding-right: 0.75rem !important; }
        .py-1 { padding-top: 0.25rem !important; padding-bottom: 0.25rem !important; }
      }
    </style>
  </head>
  <body class="min-h-screen text-gray-100">
    <div id="app" class="mx-auto mt-8 space-y-8">
      <p class="text-sm sm:text-base">–ü—Ä–∏–≤–µ—Ç üëã –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ø–∏—à–∏ –≤ telegram @ouchnomad</p>
      <!-- –ë–ª–æ–∫: –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
      <div class="bg-gray-900 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
        <section>
          <h2 class="text-lg font-semibold mb-2">üôãüèª‚Äç‚ôÇÔ∏è –£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
          <form @submit.prevent="addParticipant" class="flex flex-col sm:flex-row gap-2 mb-3">
            <input
              v-model="newParticipant"
              type="text"
              placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞"
              class="border border-gray-700 bg-gray-900 text-gray-100 rounded px-2 py-1 flex-1 placeholder-gray-400"
            />
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded w-full sm:w-auto">–î–æ–±–∞–≤–∏—Ç—å</button>
          </form>
          <ul class="flex flex-wrap gap-2">
            <li v-for="(p, idx) in state.participants" :key="p" class="bg-gray-700 px-3 py-1 rounded-full flex items-center">
              {{ p }}
              <button @click="removeParticipant(idx)" class="ml-2 text-red-400 font-bold hover:text-red-300">&times;</button>
            </li>
          </ul>
        </section>
      </div>

      <!-- –ë–ª–æ–∫: –¢—Ä–∞—Ç—ã -->
      <div class="bg-gray-900 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
        <section>
          <h2 class="text-lg font-semibold mb-2">üí∞ –¢—Ä–∞—Ç—ã</h2>
          <form @submit.prevent="addExpense" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" autocomplete="off">
            <!-- –ü–ª–∞—Ç–µ–ª—å—â–∏–∫ -->
            <div class="md:col-span-2">
              <label class="block mb-1 font-medium">–ö—Ç–æ –æ–ø–ª–∞—Ç–∏–ª?</label>
              <select v-model="expenseForm.payer" class="border border-gray-700 bg-gray-900 text-gray-100 rounded px-2 py-1 w-full">
                <option value="" disabled>–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞</option>
                <option v-for="p in state.participants" :key="p" :value="p">{{ p }}</option>
              </select>
            </div>
            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="md:col-span-2">
              <label class="block mb-1 font-medium">–ó–∞ —á—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
              <input v-model="expenseForm.description" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –∑–∞ —É–∂–∏–Ω" class="border border-gray-700 bg-gray-900 text-gray-100 rounded px-2 py-1 w-full placeholder-gray-400" />
            </div>

            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç—Ä–∞—Ç—ã -->
            <div class="md:col-span-2 mb-2">
              <label class="block mb-1 font-medium">–ö–∞–∫ —Ä–∞–∑–¥–µ–ª–∏—Ç—å —Ç—Ä–∞—Ç—É?</label>
              <div class="flex flex-col sm:flex-row gap-2 sm:gap-4">
                <label class="flex items-center cursor-pointer">
                  <input
                    type="radio"
                    value="even"
                    v-model="expenseForm.splitMode"
                    class="mr-2"
                  />
                  <span>–ü–æ—Ä–æ–≤–Ω—É</span>
                </label>
                <label class="flex items-center cursor-pointer">
                  <input
                    type="radio"
                    value="items"
                    v-model="expenseForm.splitMode"
                    class="mr-2"
                  />
                  <span>–ü–æ –ø–æ–∑–∏—Ü–∏—è–º</span>
                </label>
              </div>
            </div>

            <!-- –ü–æ–ª—è –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ø–æ—Ä–æ–≤–Ω—É" -->
            <template v-if="expenseForm.splitMode === 'even'">
              <!-- –ó–∞ –∫–æ–≥–æ –æ–ø–ª–∞—á–µ–Ω–æ? -->
              <div class="md:col-span-2">
                <label class="block mb-1 font-medium">–ó–∞ –∫–æ–≥–æ –æ–ø–ª–∞—á–µ–Ω–æ?</label>
                <div class="flex flex-wrap gap-2">
                  <button
                    v-for="p in state.participants"
                    :key="p"
                    type="button"
                    @click="toggleForWhom(p)"
                    :class="[
                      'px-3 py-1 rounded-full border',
                      expenseForm.forWhom.includes(p) ? 'bg-green-600 text-white border-green-600' : 'bg-gray-800 text-gray-200 border-gray-700',
                      'focus:outline-none'
                    ]"
                  >
                    {{ p }}
                  </button>
                  <button
                    v-if="state.participants.length"
                    type="button"
                    @click="selectAllForWhom"
                    :class="[
                      'px-3 py-1 rounded-full border',
                      expenseForm.forWhom.length === state.participants.length ? 'bg-green-700 text-white border-green-700' : 'bg-gray-700 text-gray-300 border-gray-600',
                      'focus:outline-none'
                    ]"
                  >
                    –í—Å–µ
                  </button>
                </div>
              </div>
              <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å—É–º–º—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ø–æ—Ä–æ–≤–Ω—É" -->
              <div class="md:col-span-2">
                <label class="block mb-1 font-medium">–°—É–º–º–∞</label>
                <input
                  v-model.number="expenseForm.amount"
                  type="number"
                  min="0"
                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                  class="border border-gray-700 bg-gray-900 text-gray-100 rounded px-2 py-1 w-full placeholder-gray-400"
                  inputmode="decimal"
                  pattern="[0-9]*"
                />
              </div>
            </template>

            <!-- –ü–æ–ª—è –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ø–æ –ø–æ–∑–∏—Ü–∏—è–º" -->
            <template v-if="expenseForm.splitMode === 'items'">
              <div class="md:col-span-2">
                <label class="block mb-1 font-medium">–ü–æ–∑–∏—Ü–∏–∏ –≤ —á–µ–∫–µ:</label>
                <button type="button" @click="addItem" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mb-2 w-full sm:w-auto">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
                
                <div v-for="(item, itemIndex) in expenseForm.items" :key="item.id" class="border border-gray-700 bg-gray-900 rounded p-3 mb-2">
                  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-2">
                    <span class="font-medium">–ü–æ–∑–∏—Ü–∏—è {{ itemIndex + 1 }}</span>
                    <button type="button" @click="removeItem(itemIndex)" class="text-red-400 font-bold hover:text-red-300 self-end sm:self-auto">&times;</button>
                  </div>
                  
                  <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">
                    <input v-model="item.name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="border border-gray-700 bg-gray-800 text-gray-100 rounded px-2 py-1 placeholder-gray-400" />
                    <input v-model.number="item.price" type="number" min="0" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å" class="border border-gray-700 bg-gray-800 text-gray-100 rounded px-2 py-1 placeholder-gray-400" inputmode="decimal" pattern="[0-9]*" />
                    <input v-model.number="item.quantity" type="number" min="1" placeholder="–ö–æ–ª-–≤–æ" class="border border-gray-700 bg-gray-800 text-gray-100 rounded px-2 py-1 placeholder-gray-400" inputmode="numeric" pattern="[0-9]*" />
                  </div>
                  
                  <div>
                    <label class="block mb-1 font-medium">–ö—Ç–æ –µ–ª/–ø–∏–ª?</label>
                    <div class="flex flex-wrap gap-2">
                      <button
                        v-for="p in state.participants"
                        :key="p"
                        type="button"
                        @click="toggleItemConsumer(itemIndex, p)"
                        :class="[
                          'px-3 py-1 rounded-full border',
                          item.consumers.includes(p) ? 'bg-green-600 text-white border-green-600' : 'bg-gray-800 text-gray-200 border-gray-700',
                          'focus:outline-none'
                        ]"
                      >
                        {{ p }}
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã —á–µ–∫–∞ (–≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ "–ø–æ –ø–æ–∑–∏—Ü–∏—è–º") -->
                <div class="bg-gray-800 p-2 rounded flex flex-col gap-1 mb-2">
                  <div class="flex flex-col sm:flex-row items-start sm:items-center">
                    <span class="font-medium">–û–±—â–∞—è —Å—É–º–º–∞ —á–µ–∫–∞:</span>
                    <input
                      v-model.number="expenseForm.amount"
                      type="number"
                      min="0"
                      placeholder="–í–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É —á–µ–∫–∞"
                      class="border border-gray-700 bg-gray-900 text-gray-100 rounded px-2 py-1 w-full sm:w-80 sm:ml-2 mt-2 sm:mt-0 placeholder-gray-400"
                      inputmode="decimal"
                      pattern="[0-9]*"
                    />
                    <span class="ml-2 text-gray-500" title="–í–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –∏–∑ —á–µ–∫–∞. –ú—ã —Å–≤–µ—Ä–∏–º –µ–µ —Å —Å—É–º–º–æ–π –ø–æ–∑–∏—Ü–∏–π –Ω–∏–∂–µ.">‚ìò</span>
                  </div>
                </div>

                <div class="bg-gray-800 p-2 rounded flex flex-col gap-1">
                  <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
                    <strong>–°—É–º–º–∞ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º: {{ calculatedTotal }}‚ÇΩ</strong>
                    <span
                      v-if="expenseForm.amount !== null && expenseForm.amount !== ''"
                      :class="{
                        'text-green-400 font-semibold': Math.abs(calculatedTotal - expenseForm.amount) < 0.01,
                        'text-yellow-400 font-semibold': calculatedTotal < expenseForm.amount - 0.01,
                        'text-red-400 font-semibold': calculatedTotal > expenseForm.amount + 0.01
                      }"
                    >
                      <template v-if="Math.abs(calculatedTotal - expenseForm.amount) < 0.01">
                        ‚úî –í—Å–µ –≤–µ—Ä–Ω–æ!
                      </template>
                      <template v-else-if="calculatedTotal < expenseForm.amount - 0.01">
                        ‚ö† –û—Å—Ç–∞—Ç–æ–∫ –∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é: {{ (expenseForm.amount - calculatedTotal).toFixed(2) }}‚ÇΩ
                        <span
                          class="underline cursor-pointer ml-2"
                          @click="showRemainderActions = !showRemainderActions"
                          title="–ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å –æ—Å—Ç–∞—Ç–∫–æ–º?"
                        >[?]</span>
                      </template>
                      <template v-else-if="calculatedTotal > expenseForm.amount + 0.01">
                        ‚ùó –ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥! –†–∞–∑–Ω–∏—Ü–∞: {{ (calculatedTotal - expenseForm.amount).toFixed(2) }}‚ÇΩ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ü–µ–Ω—ã.
                      </template>
                    </span>
                  </div>
                  <!-- –î–µ–π—Å—Ç–≤–∏—è –ø–æ –æ—Å—Ç–∞—Ç–∫—É -->
                  <div v-if="showRemainderActions && expenseForm.amount !== null && expenseForm.amount !== '' && calculatedTotal < expenseForm.amount - 0.01" class="mt-2 flex flex-col gap-1">
                    <button
                      type="button"
                      class="bg-yellow-700 hover:bg-yellow-800 text-yellow-200 px-2 py-1 rounded text-sm w-full sm:w-max"
                      @click="addTipItem"
                    >–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é "–ß–∞–µ–≤—ã–µ"</button>
                    <button
                      type="button"
                      class="bg-yellow-700 hover:bg-yellow-800 text-yellow-200 px-2 py-1 rounded text-sm w-full sm:w-max"
                      @click="addOtherItem"
                    >–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é "–ü—Ä–æ—á–µ–µ"</button>
                    <button
                      type="button"
                      class="bg-yellow-700 hover:bg-yellow-800 text-yellow-200 px-2 py-1 rounded text-sm w-full sm:w-max"
                      @click="spreadRemainder"
                    >–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</button>
                  </div>
                </div>
                <div v-if="!expenseForm.items.length" class="text-gray-500 p-2">–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é</div>
                <!-- –í—ã–≤–æ–¥ –æ—à–∏–±–æ–∫ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ø–æ –ø–æ–∑–∏—Ü–∏—è–º" -->
                <div v-if="expenseForm.splitMode === 'items' && itemsErrors.length" class="bg-red-900 text-red-300 rounded p-2 mt-2 text-sm">
                  <ul class="list-disc pl-5">
                    <li v-for="(err, idx) in itemsErrors" :key="idx">{{ err }}</li>
                  </ul>
                </div>
              </div>
            </template>

            <button
              type="submit"
              class="bg-green-700 hover:bg-green-800 text-white px-3 py-1 rounded md:col-span-2 w-full sm:w-auto"
              :disabled="expenseForm.splitMode === 'items' ? itemsErrors.length > 0 : false"
              :class="{
                'opacity-50 cursor-not-allowed': expenseForm.splitMode === 'items' && itemsErrors.length > 0
              }"
            >–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</button>
          </form>
          <ul v-if="state.expenses.length" class="mt-3 space-y-1">
            <li v-for="e in state.expenses" :key="e.id" class="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-800 px-2 py-1 rounded">
              <span>
                <b>{{ e.payer }}</b> –æ–ø–ª–∞—Ç–∏–ª <b>{{ e.amount }}‚ÇΩ </b>
                <span v-if="e.description">({{ e.description }})</span>
                <span v-if="e.splitMode === 'even'"> –∑–∞: <span class="italic">{{ e.forWhom.join(', ') }}</span></span>
                <span v-else-if="e.splitMode === 'items'">
                  –ø–æ –ø–æ–∑–∏—Ü–∏—è–º
                  <span v-if="e.items && e.items.length">
                    <span
                      v-if="Math.abs(e.amount - (e.items.reduce((t, item) => t + item.price * item.quantity, 0))) < 0.01"
                      class="ml-2 text-green-400 font-semibold"
                      title="–°—É–º–º–∞ –ø–æ–∑–∏—Ü–∏–π —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å—É–º–º–æ–π —á–µ–∫–∞"
                    >‚úî</span>
                    <span
                      v-else-if="e.items.reduce((t, item) => t + item.price * item.quantity, 0) < e.amount - 0.01"
                      class="ml-2 text-yellow-400 font-semibold"
                      title="–û—Å—Ç–∞—Ç–æ–∫ –∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é"
                    >‚ö† –û—Å—Ç–∞—Ç–æ–∫: {{ (e.amount - e.items.reduce((t, item) => t + item.price * item.quantity, 0)).toFixed(2) }}‚ÇΩ</span>
                    <span
                      v-else
                      class="ml-2 text-red-400 font-semibold"
                      title="–ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥"
                    >‚ùó –ü–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥: {{ (e.items.reduce((t, item) => t + item.price * item.quantity, 0) - e.amount).toFixed(2) }}‚ÇΩ</span>
                  </span>
                </span>
              </span>
              <button @click="removeExpense(e.id)" class="text-red-400 font-bold hover:text-red-300 mt-2 sm:mt-0 self-end sm:self-auto">&times;</button>
            </li>
          </ul>
        </section>
      </div>

      <!-- –ë–ª–æ–∫: –ö–æ–º—É –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ -->
      <div class="bg-gray-900 rounded-lg shadow-lg p-6 border border-gray-700">
        <section>
          <h2 class="text-lg font-semibold mb-2">‚úÖ –ö–æ–º—É –ø–µ—Ä–µ–≤–µ—Å—Ç–∏:</h2>
          <ul v-if="transfers.length" class="list-disc pl-5 space-y-1">
            <li v-for="(t, idx) in transfers" :key="idx">
              <b>{{ t.from }}</b> ‚Üí <b>{{ t.to }}</b>: <b>{{ t.amount.toFixed(2) }}‚ÇΩ</b>
            </li>
          </ul>
          <div v-else class="text-gray-500">–ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>
        </section>
      </div>
    </div>

    <script>
      const { createApp, reactive, computed, watch, ref } = Vue;

      createApp({
        setup() {
          // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
          const state = reactive({
            eventName: '',
            participants: [],
            expenses: []
          });

          // --- –í–≤–æ–¥—ã ---
          const newParticipant = ref('');
          const expenseForm = reactive({
            payer: '',
            amount: null,
            description: '',
            forWhom: [],
            splitMode: 'even',
            items: []
          });

          // --- UI —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ ---
          const showRemainderActions = ref(false);

          // --- –û—à–∏–±–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ø–æ –ø–æ–∑–∏—Ü–∏—è–º" ---
          const itemsErrors = computed(() => {
            if (expenseForm.splitMode !== 'items') return [];
            const errors = [];
            if (!expenseForm.payer) errors.push('–ù–µ –≤—ã–±—Ä–∞–Ω –ø–ª–∞—Ç–µ–ª—å—â–∏–∫.');
            if (!expenseForm.items.length) errors.push('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é.');
            if (expenseForm.amount === null || expenseForm.amount === '' || expenseForm.amount <= 0) errors.push('–í–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É —á–µ–∫–∞ (–±–æ–ª—å—à–µ 0).');
            expenseForm.items.forEach((item, idx) => {
              if (!item.name || !item.name.trim()) errors.push(`–ü–æ–∑–∏—Ü–∏—è ${idx + 1}: –Ω–µ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ.`);
              if (item.price <= 0) errors.push(`–ü–æ–∑–∏—Ü–∏—è ${idx + 1}: —Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.`);
              if (item.quantity <= 0) errors.push(`–ü–æ–∑–∏—Ü–∏—è ${idx + 1}: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.`);
              if (!item.consumers || !item.consumers.length) errors.push(`–ü–æ–∑–∏—Ü–∏—è ${idx + 1}: –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –µ–¥–æ–∫–∞.`);
            });
            return errors;
          });

          // --- LocalStorage ---
          const STORAGE_KEY = 'debt_calc_state_v2';
          function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
              eventName: state.eventName,
              participants: state.participants,
              expenses: state.expenses
            }));
          }
          function loadState() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
              try {
                const parsed = JSON.parse(data);
                state.eventName = parsed.eventName || '';
                state.participants = parsed.participants || [];
                state.expenses = parsed.expenses || [];
              } catch {}
            }
          }
          loadState();

          watch(state, saveState, { deep: true });

          // --- –ú–µ—Ç–æ–¥—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ---
          function addParticipant() {
            const name = newParticipant.value.trim();
            if (name && !state.participants.includes(name)) {
              state.participants.push(name);
              newParticipant.value = '';
            }
          }
          function removeParticipant(idx) {
            const name = state.participants[idx];
            state.participants.splice(idx, 1);
            // –£–¥–∞–ª—è–µ–º –∏–∑ forWhom –≤ —Ç—Ä–∞—Ç–∞—Ö
            state.expenses.forEach(e => {
              if (e.splitMode === 'even') {
                e.forWhom = e.forWhom.filter(p => p !== name);
              } else if (e.splitMode === 'items') {
                e.items.forEach(item => {
                  item.consumers = item.consumers.filter(p => p !== name);
                });
              }
            });
            // –£–¥–∞–ª—è–µ–º —Ç—Ä–∞—Ç—ã, –≥–¥–µ payer –±—ã–ª —É–¥–∞–ª—ë–Ω
            state.expenses = state.expenses.filter(e => e.payer !== name);
          }

          // --- –ú–µ—Ç–æ–¥—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ forWhom (chips) ---
          function toggleForWhom(p) {
            const idx = expenseForm.forWhom.indexOf(p);
            if (idx === -1) {
              expenseForm.forWhom.push(p);
            } else {
              expenseForm.forWhom.splice(idx, 1);
            }
          }
          function selectAllForWhom() {
            if (expenseForm.forWhom.length === state.participants.length) {
              expenseForm.forWhom = [];
            } else {
              expenseForm.forWhom = [...state.participants];
            }
          }

          // --- –ú–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–π ---
          function addItem() {
            expenseForm.items.push({
              id: Date.now() + Math.random(),
              name: '',
              price: 0,
              quantity: 1,
              consumers: []
            });
          }
          function removeItem(itemIndex) {
            expenseForm.items.splice(itemIndex, 1);
          }
          function toggleItemConsumer(itemIndex, participant) {
            const item = expenseForm.items[itemIndex];
            const idx = item.consumers.indexOf(participant);
            if (idx === -1) {
              item.consumers.push(participant);
            } else {
              item.consumers.splice(idx, 1);
            }
          }

          // --- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—É–º–º—ã –ø–æ–∑–∏—Ü–∏–π ---
          const calculatedTotal = computed(() => {
            return expenseForm.items.reduce((total, item) => {
              return total + (item.price * item.quantity);
            }, 0);
          });

          // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
          const totalItemsAmount = calculatedTotal;

          // --- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã –ø–æ–∑–∏—Ü–∏–π –∏ amount ---
          watch(
            () => [expenseForm.items.map(i => [i.price, i.quantity]), expenseForm.amount],
            () => {
              // UI –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
              showRemainderActions.value = false;
            },
            { deep: true }
          );

          // --- –î–µ–π—Å—Ç–≤–∏—è –ø–æ –æ—Å—Ç–∞—Ç–∫—É ---
          function addTipItem() {
            const remainder = +(expenseForm.amount - calculatedTotal.value).toFixed(2);
            if (remainder > 0.01) {
              expenseForm.items.push({
                id: Date.now() + Math.random(),
                name: '–ß–∞–µ–≤—ã–µ',
                price: remainder,
                quantity: 1,
                consumers: [...state.participants]
              });
              showRemainderActions.value = false;
            }
          }
          function addOtherItem() {
            const remainder = +(expenseForm.amount - calculatedTotal.value).toFixed(2);
            if (remainder > 0.01) {
              expenseForm.items.push({
                id: Date.now() + Math.random(),
                name: '–ü—Ä–æ—á–µ–µ',
                price: remainder,
                quantity: 1,
                consumers: [...state.participants]
              });
              showRemainderActions.value = false;
            }
          }
          function spreadRemainder() {
            const remainder = +(expenseForm.amount - calculatedTotal.value).toFixed(2);
            if (remainder > 0.01 && expenseForm.items.length) {
              // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
              const sum = expenseForm.items.reduce((s, item) => s + (item.price * item.quantity), 0);
              if (sum === 0) return;
              expenseForm.items.forEach(item => {
                const part = (item.price * item.quantity) / sum;
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º price —Ç–æ–ª—å–∫–æ —É –ø–µ—Ä–≤–æ–π quantity (–µ—Å–ª–∏ quantity > 1, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º price)
                item.price = +(item.price + remainder * part / item.quantity).toFixed(2);
              });
              showRemainderActions.value = false;
            }
          }

          // --- –ú–µ—Ç–æ–¥—ã —Ç—Ä–∞—Ç ---
          function addExpense() {
            if (!expenseForm.payer) return;

            if (expenseForm.splitMode === 'even') {
              if (!expenseForm.amount || expenseForm.amount <= 0) return;
              let forWhom = expenseForm.forWhom.length ? [...expenseForm.forWhom] : [...state.participants];
              // –ü—Ä–æ–≤–µ—Ä–∫–∞: payer –∏ forWhom –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö
              if (!state.participants.includes(expenseForm.payer)) return;
              forWhom = forWhom.filter(p => state.participants.includes(p));
              if (!forWhom.length) return;

              state.expenses.push({
                id: Date.now() + Math.random(),
                payer: expenseForm.payer,
                amount: Number(expenseForm.amount),
                description: expenseForm.description,
                splitMode: 'even',
                forWhom,
                items: []
              });
            } else if (expenseForm.splitMode === 'items') {
              // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤—Å–µ –≤–∞–ª–∏–¥–Ω–æ
              if (itemsErrors.value.length > 0) return;

              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –≤–∞–ª–∏–¥–Ω—ã
              const validItems = expenseForm.items.filter(item =>
                item.name && item.name.trim() &&
                item.price > 0 &&
                item.quantity > 0 &&
                item.consumers && item.consumers.length > 0
              );
              // calculatedTotal –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ expense
              const calcTotal = validItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

              state.expenses.push({
                id: Date.now() + Math.random(),
                payer: expenseForm.payer,
                amount: Number(expenseForm.amount), // amount ‚Äî —ç—Ç–∞–ª–æ–Ω–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞
                description: expenseForm.description,
                splitMode: 'items',
                forWhom: [],
                items: validItems.map(item => ({
                  ...item,
                  consumers: item.consumers.filter(p => state.participants.includes(p))
                })),
                calculatedTotal: calcTotal
              });
            }

            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            expenseForm.payer = '';
            expenseForm.amount = null;
            expenseForm.description = '';
            expenseForm.forWhom = [];
            expenseForm.splitMode = 'even';
            expenseForm.items = [];
            showRemainderActions.value = false;
          }
          function removeExpense(id) {
            state.expenses = state.expenses.filter(e => e.id !== id);
          }

          // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–µ—Ç–∞–ª–µ–π —Ç—Ä–∞—Ç—ã ---
          function calculateExpenseDetails(expense) {
            const details = {};

            if (expense.splitMode === 'even') {
              // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞: –¥–µ–ª–∏–º –ø–æ—Ä–æ–≤–Ω—É
              const share = expense.amount / expense.forWhom.length;
              expense.forWhom.forEach(p => {
                details[p] = (details[p] || 0) + share;
              });
            } else if (expense.splitMode === 'items') {
              // –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞: –ø–æ –ø–æ–∑–∏—Ü–∏—è–º —Å –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π
              // amount ‚Äî —ç—Ç–∞–ª–æ–Ω–Ω–∞—è —Å—É–º–º–∞ —á–µ–∫–∞
              // calculatedTotal ‚Äî —Å—É–º–º–∞ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —Ä–∞–≤–Ω–∞ amount)
              let calcTotal = 0;
              if (typeof expense.calculatedTotal === 'number') {
                calcTotal = expense.calculatedTotal;
              } else if (expense.items && expense.items.length) {
                calcTotal = expense.items.reduce((total, item) => total + (item.price * item.quantity), 0);
              }
              let scale = 1;
              if (calcTotal > 0 && typeof expense.amount === 'number') {
                scale = expense.amount / calcTotal;
              }
              expense.items.forEach(item => {
                const itemTotal = item.price * item.quantity * scale;
                const share = item.consumers.length > 0 ? itemTotal / item.consumers.length : 0;
                item.consumers.forEach(p => {
                  details[p] = (details[p] || 0) + share;
                });
              });
            }

            return details;
          }

          // --- –†–∞—Å—á—ë—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ---
          const transfers = computed(() => {
            if (!state.participants.length || !state.expenses.length) return [];

            // 1. –°—á–∏—Ç–∞–µ–º totalPaid –∏ totalDebt –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
            const balances = {};
            state.participants.forEach(p => {
              balances[p] = { paid: 0, debt: 0, balance: 0 };
            });

            state.expenses.forEach(e => {
              if (balances[e.payer]) {
                balances[e.payer].paid += e.amount;
              }

              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–æ–ª–≥–æ–≤
              const expenseDetails = calculateExpenseDetails(e);
              Object.entries(expenseDetails).forEach(([participant, debt]) => {
                if (balances[participant]) {
                  balances[participant].debt += debt;
                }
              });
            });

            state.participants.forEach(p => {
              balances[p].balance = +(balances[p].paid - balances[p].debt).toFixed(2);
            });

            // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
            const people = state.participants.map(p => ({
              name: p,
              balance: balances[p].balance
            }));

            // 3. –ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
            function calculateTransfers(people) {
              const res = [];
              // –ö–æ–ø–∏—Ä—É–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
              let debtors = people.filter(p => p.balance < -0.01).map(p => ({...p}));
              let creditors = people.filter(p => p.balance > 0.01).map(p => ({...p}));
              // –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –∫–æ–ø–µ–µ–∫
              debtors.forEach(d => d.balance = +d.balance.toFixed(2));
              creditors.forEach(c => c.balance = +c.balance.toFixed(2));
              // –ü–æ–∫–∞ –µ—Å—Ç—å –¥–æ–ª–∂–Ω–∏–∫–∏ –∏ –∫—Ä–µ–¥–∏—Ç–æ—Ä—ã
              while (debtors.length && creditors.length) {
                // –°–∞–º—ã–π –±–æ–ª—å—à–æ–π –¥–æ–ª–∂–Ω–∏–∫ –∏ –∫—Ä–µ–¥–∏—Ç–æ—Ä
                debtors.sort((a, b) => a.balance - b.balance); // –ø–æ —É–±—ã–≤–∞–Ω–∏—é (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ)
                creditors.sort((a, b) => b.balance - a.balance); // –ø–æ —É–±—ã–≤–∞–Ω–∏—é
                let debtor = debtors[0];
                let creditor = creditors[0];
                let amount = Math.min(-debtor.balance, creditor.balance);
                amount = +amount.toFixed(2);
                if (amount < 0.01) break;
                res.push({ from: debtor.name, to: creditor.name, amount });
                debtor.balance += amount;
                creditor.balance -= amount;
                // –£–¥–∞–ª—è–µ–º, –µ—Å–ª–∏ –±–∞–ª–∞–Ω—Å ~0
                if (debtor.balance > -0.01) debtors.shift();
                if (creditor.balance < 0.01) creditors.shift();
              }
              return res;
            }

            return calculateTransfers(people);
          });

          // --- –í–æ–∑–≤—Ä–∞—Ç –≤ —à–∞–±–ª–æ–Ω ---
          return {
            state,
            newParticipant,
            expenseForm,
            addParticipant,
            removeParticipant,
            addExpense,
            removeExpense,
            transfers,
            toggleForWhom,
            selectAllForWhom,
            addItem,
            removeItem,
            toggleItemConsumer,
            totalItemsAmount,
            calculatedTotal,
            showRemainderActions,
            addTipItem,
            addOtherItem,
            spreadRemainder,
            itemsErrors
          };
        }
      }).mount('#app');
    </script>
  </body>
</html>
